<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PowerArka</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <style>
        /* Define custom properties for the new color palette */
        :root {
            --color-primary: #00A0AF; /* Teal from icon */
            --color-primary-hover: #008a97; /* Darker teal */
            --color-secondary: #FFC107; /* Orange/Yellow from icon */
            --color-secondary-hover: #e0a800; /* Darker orange/yellow */
            --color-text-light: #f8fafc; /* Tailwind gray-50 */
            --color-text-dark: #1f2937; /* Tailwind gray-800 */
            --color-text-medium: #4b5563; /* Tailwind gray-600 */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* Tailwind gray-50 */
            color: var(--color-text-dark);
        }

        /* Simple page transition effect */
        .page {
            display: none; /* Hide pages by default */
            animation: fadeIn 0.5s ease-in-out;
        }
        .page.active {
            display: block; /* Show active page */
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Style for active nav link */
        .nav-link.active {
            font-weight: 600;
            color: var(--color-primary);
        }
        .nav-link:not(.active):hover {
             color: var(--color-primary);
        }

        /* Custom button base styles */
        .btn {
             display: inline-block;
             padding: 0.75rem 1.5rem; /* px-6 py-3 */
             border-radius: 0.5rem; /* rounded-lg */
             box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* shadow-md */
             transition: all 0.3s ease-in-out;
             font-weight: 500; /* medium */
             text-align: center;
             cursor: pointer;
             border: 1px solid transparent; /* Base border */
        }
        .btn:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(0, 160, 175, 0.4); /* Focus ring with primary color */
        }
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Button variants using custom properties */
        .btn-primary {
            background-color: var(--color-primary);
            color: var(--color-text-light);
            border-color: var(--color-primary);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--color-primary-hover);
            border-color: var(--color-primary-hover);
        }

        .btn-secondary {
            background-color: var(--color-secondary);
            color: var(--color-text-dark); /* Better contrast on yellow */
            border-color: var(--color-secondary);
        }
        .btn-secondary:hover:not(:disabled) {
            background-color: var(--color-secondary-hover);
            border-color: var(--color-secondary-hover);
        }

        .btn-outline-primary {
             background-color: transparent;
             border: 1px solid var(--color-primary);
             color: var(--color-primary);
        }
        .btn-outline-primary:hover:not(:disabled) {
            background-color: var(--color-primary);
            color: var(--color-text-light);
        }

         /* Form input styling */
        .form-input {
            width: 100%;
            padding: 0.5rem 1rem; /* px-4 py-2 */
            border: 1px solid #d1d5db; /* border-gray-300 */
            border-radius: 0.5rem; /* rounded-lg */
            transition: border-color 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 160, 175, 0.3); /* focus:ring-2 focus:ring-teal-400 */
        }
        .form-input.border-red-500 { /* Keep error state clear */
             border-color: #ef4444; /* Tailwind red-500 */
        }
        .form-input.border-red-500:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.3);
        }
        /* Style for form radio buttons */
        .form-radio {
            color: var(--color-primary); /* Change radio button color */
        }
        .form-radio:focus {
            box-shadow: 0 0 0 3px rgba(0, 160, 175, 0.3);
        }


        /* Product card styling */
        .product-card {
            background-color: white;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); /* shadow-lg */
            overflow: hidden;
            transition: transform 0.3s ease-in-out;
        }
        .product-card:hover {
            transform: scale(1.05);
        }

        /* Message Box Styling (Keeping standard colors for clarity) */
        #message-box {
            position: fixed;
            top: 1.25rem; /* top-5 */
            right: 1.25rem; /* right-5 */
            padding: 1rem; /* p-4 */
            border-radius: 0.5rem; /* rounded-lg */
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); /* shadow-md */
            color: white;
            max-width: 24rem; /* max-w-sm */
            z-index: 50;
            display: none; /* hidden */
            animation: slideIn 0.5s ease-out;
        }
        #message-box.success { background-color: #22c55e; } /* bg-green-500 */
        #message-box.error { background-color: #ef4444; } /* bg-red-500 */
        #message-box.info { background-color: #3b82f6; } /* bg-blue-500 */

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="text-gray-800">

    <header class="bg-white shadow-md sticky top-0 z-40">
        <nav class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="#home" class="flex items-center text-2xl font-bold nav-link" data-page="home" style="color: var(--color-primary);">
                <img src="icon.jpg" alt="PowerArka Logo" class="inline h-8 w-8 mr-2 rounded"> PowerArka
            </a>
            <div class="space-x-6 flex items-center">
                <a href="#home" class="text-gray-600 nav-link active" data-page="home">Home</a>
                <a href="#products" class="text-gray-600 nav-link" data-page="products">Products</a>
                <div id="auth-links" class="space-x-4">
                     <a href="#login" class="text-gray-600 nav-link" data-page="login">Login</a>
                     <a href="#signup" class="btn btn-outline-primary text-sm" data-page="signup">Sign Up</a>
                </div>
                <div id="user-links" class="hidden space-x-4 items-center">
                    <span id="user-greeting" class="text-gray-700"></span>
                    <a href="#cart" class="relative nav-link" data-page="cart" style="color: var(--color-text-medium);">
                        <i class="fas fa-shopping-cart text-xl"></i>
                        <span id="cart-count" class="absolute -top-2 -right-2 text-white text-xs rounded-full h-4 w-4 flex items-center justify-center" style="background-color: var(--color-secondary);">0</span>
                    </a>
                    <button id="logout-button" class="text-sm" style="color: var(--color-text-medium); hover:color: var(--color-primary);">Logout</button>
                </div>
            </div>
        </nav>
    </header>

    <div id="message-box">
        <span id="message-text"></span>
        <button onclick="hideMessage()" class="ml-4 font-bold">&times;</button>
    </div>

    <main class="container mx-auto px-6 py-8">

        <section id="home" class="page active">
            <div class="text-white rounded-xl shadow-xl p-12 text-center mb-12" style="background: linear-gradient(to right, var(--color-primary), #00c4d4);">
                <h1 class="text-4xl md:text-5xl font-bold mb-4">Power Your Future with Solar</h1>
                <p class="text-lg md:text-xl mb-8 opacity-90">Sustainable energy solutions for homes and businesses.</p>
                <a href="#products" class="btn bg-white hover:bg-gray-100 nav-link" data-page="products" style="color: var(--color-primary);">Explore Products</a>
            </div>

            <div class="grid md:grid-cols-3 gap-8 text-center">
                 <div class="bg-white p-6 rounded-lg shadow-md">
                    <i class="fas fa-home text-4xl mb-4" style="color: var(--color-primary);"></i>
                    <h3 class="text-xl font-semibold mb-2">Residential Solar</h3>
                    <p class="text-gray-600">Lower your electricity bills and carbon footprint with home solar panels.</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <i class="fas fa-building text-4xl mb-4" style="color: var(--color-primary);"></i>
                    <h3 class="text-xl font-semibold mb-2">Commercial Solutions</h3>
                    <p class="text-gray-600">Cost-effective and reliable solar power for your business operations.</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <i class="fas fa-tools text-4xl mb-4" style="color: var(--color-primary);"></i>
                    <h3 class="text-xl font-semibold mb-2">Installation & Maintenance</h3>
                    <p class="text-gray-600">Expert installation and ongoing support for your solar system.</p>
                </div>
            </div>
        </section>

        <section id="products" class="page">
            <h2 class="text-3xl font-bold mb-8 text-center">Our Solar Products</h2>
            <div id="product-list" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8">
                <div class="product-card animate-pulse"> <div class="h-48 bg-gray-300"></div>
                    <div class="p-4">
                        <div class="h-6 bg-gray-300 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-300 rounded w-1/2 mb-4"></div>
                        <div class="h-10 bg-gray-400 rounded w-1/3"></div>
                    </div>
                 </div>
                 <div class="product-card animate-pulse"> <div class="h-48 bg-gray-300"></div>
                    <div class="p-4">
                        <div class="h-6 bg-gray-300 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-300 rounded w-1/2 mb-4"></div>
                        <div class="h-10 bg-gray-400 rounded w-1/3"></div>
                    </div>
                 </div>
                 <div class="product-card animate-pulse"> <div class="h-48 bg-gray-300"></div>
                    <div class="p-4">
                        <div class="h-6 bg-gray-300 rounded w-3/4 mb-2"></div>
                        <div class="h-4 bg-gray-300 rounded w-1/2 mb-4"></div>
                        <div class="h-10 bg-gray-400 rounded w-1/3"></div>
                    </div>
                 </div>
            </div>
        </section>

        <section id="login" class="page">
            <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-center">Login</h2>
                <form id="login-form" class="space-y-4">
                    <div>
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="login-email" class="form-input" required>
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Password</label>
                        <input type="password" id="login-password" class="form-input" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-full">Login</button>
                </form>
                <p class="text-center text-gray-600 text-sm my-4">OR</p>
                 <form id="phone-login-form" class="space-y-4">
                     <div>
                        <label for="login-phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number (e.g., +16505551234)</label>
                        <input type="tel" id="login-phone" class="form-input" required>
                        <div id="recaptcha-container-login" class="mt-2"></div>
                    </div>
                    <button type="button" id="send-otp-button" class="btn btn-secondary w-full">Send OTP</button>
                    <div id="otp-login-section" class="hidden space-y-4 mt-4">
                         <label for="login-otp" class="block text-sm font-medium text-gray-700 mb-1">Enter OTP</label>
                        <input type="text" id="login-otp" class="form-input" required>
                        <button type="button" id="verify-otp-login-button" class="btn btn-primary w-full">Verify OTP & Login</button>
                    </div>
                </form>
                <p class="mt-6 text-center text-sm">
                    Don't have an account? <a href="#signup" class="nav-link" data-page="signup" style="color: var(--color-primary); hover:underline;">Sign Up</a>
                </p>
            </div>
        </section>

        <section id="signup" class="page">
            <div class="max-w-md mx-auto bg-white p-8 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-6 text-center">Sign Up</h2>
                <form id="signup-form" class="space-y-4">
                    <div>
                        <label for="signup-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="signup-email" class="form-input" required>
                    </div>
                    <div>
                        <label for="signup-password" class="block text-sm font-medium text-gray-700 mb-1">Password (min. 6 characters)</label>
                        <input type="password" id="signup-password" class="form-input" required minlength="6">
                    </div>
                     <button type="submit" class="btn btn-primary w-full">Sign Up with Email</button>
                </form>
                 <p class="text-center text-gray-600 text-sm my-4">OR</p>
                 <form id="phone-signup-form" class="space-y-4">
                     <div>
                        <label for="signup-phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number (e.g., +16505551234)</label>
                        <input type="tel" id="signup-phone" class="form-input" required>
                        <div id="recaptcha-container-signup" class="mt-2"></div>
                    </div>
                    <button type="button" id="send-otp-signup-button" class="btn btn-secondary w-full">Send OTP</button>
                    <div id="otp-signup-section" class="hidden space-y-4 mt-4">
                         <label for="signup-otp" class="block text-sm font-medium text-gray-700 mb-1">Enter OTP</label>
                        <input type="text" id="signup-otp" class="form-input" required>
                        <button type="button" id="verify-otp-signup-button" class="btn btn-primary w-full">Verify OTP & Sign Up</button>
                    </div>
                </form>
                <p class="mt-6 text-center text-sm">
                    Already have an account? <a href="#login" class="nav-link" data-page="login" style="color: var(--color-primary); hover:underline;">Login</a>
                </p>
            </div>
        </section>

        <section id="cart" class="page">
             <h2 class="text-3xl font-bold mb-8">Your Shopping Cart</h2>
             <div id="cart-items" class="space-y-4">
                 <p id="empty-cart-message" class="text-gray-600">Your cart is empty.</p>
                 </div>
             <div id="cart-summary" class="mt-8 pt-4 border-t border-gray-200 text-right hidden">
                  <p class="text-xl font-semibold mb-4">Total: <span id="cart-total" style="color: var(--color-primary);">$0.00</span></p>
                 <button id="checkout-button" class="btn btn-primary">Proceed to Checkout</button>
             </div>
        </section>

        <section id="checkout" class="page">
             <h2 class="text-3xl font-bold mb-8">Checkout</h2>
             <div class="grid md:grid-cols-2 gap-8">
                 <div class="bg-white p-6 rounded-lg shadow-md">
                     <h3 class="text-xl font-semibold mb-4">Shipping Information</h3>
                     <form id="shipping-form" class="space-y-4">
                         <div>
                             <label for="name" class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>
                             <input type="text" id="name" class="form-input" required>
                         </div>
                         <div>
                             <label for="address" class="block text-sm font-medium text-gray-700 mb-1">Address</label>
                             <input type="text" id="address" class="form-input" required>
                         </div>
                         <div>
                             <label for="city" class="block text-sm font-medium text-gray-700 mb-1">City</label>
                             <input type="text" id="city" class="form-input" required>
                         </div>
                         <div class="grid grid-cols-2 gap-4">
                             <div>
                                 <label for="state" class="block text-sm font-medium text-gray-700 mb-1">State/Province</label>
                                 <input type="text" id="state" class="form-input" required>
                             </div>
                             <div>
                                 <label for="zip" class="block text-sm font-medium text-gray-700 mb-1">Zip/Postal Code</label>
                                 <input type="text" id="zip" class="form-input" required>
                             </div>
                         </div>
                         <div>
                            <label for="checkout-phone" class="block text-sm font-medium text-gray-700 mb-1">Phone Number</label>
                            <input type="tel" id="checkout-phone" class="form-input" required>
                        </div>
                     </form>
                 </div>

                 <div class="bg-white p-6 rounded-lg shadow-md">
                     <h3 class="text-xl font-semibold mb-4">Order Summary</h3>
                     <div id="checkout-summary" class="space-y-2 mb-6 pb-4 border-b border-gray-200">
                         <p class="text-gray-600">Loading summary...</p>
                     </div>
                      <p class="text-lg font-bold mb-4">Total: <span id="checkout-total" style="color: var(--color-primary);">$0.00</span></p>

                     <h3 class="text-xl font-semibold mb-4">Payment Method</h3>
                     <div class="space-y-3">
                          <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                             <input type="radio" name="payment" value="cc" class="form-radio mr-3" checked>
                             <span><i class="fas fa-credit-card mr-2" style="color: #3b82f6;"></i>Credit/Debit Card</span>
                         </label>
                         <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                             <input type="radio" name="payment" value="upi" class="form-radio mr-3">
                             <span class="font-medium" style="color: #6d28d9;">UPI</span> </label>
                         <label class="flex items-center p-3 border rounded-lg hover:bg-gray-50 cursor-pointer">
                             <input type="radio" name="payment" value="phonepe" class="form-radio mr-3">
                             <span class="font-medium" style="color: #5f259f;">PhonePe</span> </label>
                     </div>
                     <p class="text-xs text-gray-500 mt-4">
                         Note: Actual payment processing requires backend integration with payment gateways. This is a UI demonstration.
                     </p>
                      <button id="place-order-button" class="btn btn-primary w-full mt-6">Place Order (Simulated)</button>
                 </div>
             </div>
        </section>

    </main>

    <footer class="bg-gray-800 text-gray-300 mt-16">
        <div class="container mx-auto px-6 py-8">
            <div class="grid md:grid-cols-3 gap-8">
                <div>
                    <h4 class="text-lg font-semibold text-white mb-3">PowerArka</h4>
                    <p class="text-sm">Bringing sustainable energy to your doorstep.</p>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-white mb-3">Quick Links</h4>
                     <ul class="space-y-2 text-sm">
                        <li><a href="#home" class="hover:text-teal-300 nav-link" data-page="home">Home</a></li>
                        <li><a href="#products" class="hover:text-teal-300 nav-link" data-page="products">Products</a></li>
                        <li><a href="#login" class="hover:text-teal-300 nav-link" data-page="login">Login</a></li>
                    </ul>
                </div>
                <div>
                    <h4 class="text-lg font-semibold text-white mb-3">Contact Us</h4>
                     <p class="text-sm">500 Power Drive, Ottawa, ON</p>
                    <p class="text-sm">info@powerarka.example.com</p>
                    <p class="text-sm">(613) 555-0101</p>
                </div>
            </div>
            <div class="mt-8 pt-8 border-t border-gray-700 text-center text-sm">
                 &copy; <span id="current-year"></span> PowerArka. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        // --- Firebase Configuration ---
        // TODO: Replace with your actual Firebase config object
        const firebaseConfig = {
            apiKey: "AIzaSyBsS3hbeqAjXcrFoBknkAKfgS5g9vKBNjk",
            authDomain: "powerarka-6803f.firebaseapp.com",
            projectId: "powerarka-6803f",
            storageBucket: "powerarka-6803f.firebasestorage.app",
            messagingSenderId: "1035837773513",
            appId: "1:1035837773513:web:3253f9858e8c75ca48df18",
            measurementId: "G-1JEYSF0LCB"
        };

        // --- Initialize Firebase ---
        let firebaseApp;
        if (!firebase.apps.length) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
        } else {
            firebaseApp = firebase.app();
        }
        const auth = firebase.auth();

        // --- DOM Elements ---
        const pages = document.querySelectorAll('.page');
        const navLinks = document.querySelectorAll('.nav-link');
        const authLinks = document.getElementById('auth-links');
        const userLinks = document.getElementById('user-links');
        const userGreeting = document.getElementById('user-greeting');
        const logoutButton = document.getElementById('logout-button');
        const cartCountSpan = document.getElementById('cart-count');
        const productListDiv = document.getElementById('product-list');
        const cartItemsDiv = document.getElementById('cart-items');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const cartSummaryDiv = document.getElementById('cart-summary');
        const cartTotalSpan = document.getElementById('cart-total');
        const checkoutButton = document.getElementById('checkout-button');
        const checkoutSummaryDiv = document.getElementById('checkout-summary');
        const checkoutTotalSpan = document.getElementById('checkout-total');
        const placeOrderButton = document.getElementById('place-order-button');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');

        // --- App State ---
        let cart = []; // Array to hold cart items { id, name, price, quantity }
        let currentConfirmationResult = null; // For phone auth

        // --- Mock Product Data ---
        // Using teal/primary color for placeholder images
        const products = [
            { id: 'p1', name: 'Residential Solar Panel Kit (5kW)', price: 5500, description: 'High-efficiency monocrystalline panels.', imageUrl: 'https://placehold.co/600x400/00A0AF/FFFFFF?text=Solar+Panel+Kit' },
            { id: 'p2', name: 'Commercial Rooftop System (50kW)', price: 45000, description: 'Scalable solution for businesses.', imageUrl: 'https://placehold.co/600x400/00A0AF/FFFFFF?text=Commercial+System' },
            { id: 'p3', name: 'Solar Battery Storage (10kWh)', price: 8000, description: 'Store excess energy for nighttime use.', imageUrl: 'https://placehold.co/600x400/00A0AF/FFFFFF?text=Battery+Storage' },
            { id: 'p4', name: 'Portable Solar Charger', price: 150, description: 'Charge devices on the go.', imageUrl: 'https://placehold.co/600x400/00A0AF/FFFFFF?text=Portable+Charger' },
        ];

        // --- Utility Functions ---

        // Function to show a message (success, error, info)
        function showMessage(text, type = 'info') { // types: success, error, info
            messageText.textContent = text;
            // Clear existing type classes
            messageBox.classList.remove('success', 'error', 'info');
            // Add the new type class
            messageBox.classList.add(type);
            messageBox.style.display = 'block'; // Show the message box
            // Auto-hide after 5 seconds
            setTimeout(hideMessage, 5000);
        }

        // Function to hide the message box
        function hideMessage() {
            messageBox.style.display = 'none'; // Hide the message box
        }

        // Function to navigate between pages
        function navigateTo(pageId) {
            pages.forEach(page => {
                page.classList.remove('active');
                if (page.id === pageId) {
                    page.classList.add('active');
                }
            });
            // Update active nav link
            navLinks.forEach(link => {
                link.classList.remove('active');
                // Check if the link's data-page matches the target pageId
                if (link.dataset.page === pageId) {
                    link.classList.add('active');
                }
            });
            window.location.hash = pageId; // Update URL hash
            window.scrollTo(0, 0); // Scroll to top
        }

        // Function to format price
        function formatPrice(price) {
            return price.toFixed(2);
        }

        // --- Product Loading ---
        function loadProducts() {
            productListDiv.innerHTML = ''; // Clear existing products/placeholders
            if (!products || products.length === 0) {
                 productListDiv.innerHTML = '<p class="text-gray-600 col-span-full text-center">No products available at the moment.</p>';
                 return;
            }
            products.forEach(product => {
                const card = document.createElement('div');
                card.className = 'product-card';
                // Using the updated button style class 'btn-primary'
                card.innerHTML = `
                    <img src="${product.imageUrl}" alt="${product.name}" class="w-full h-48 object-cover" onerror="this.onerror=null; this.src='https://placehold.co/600x400/cccccc/ffffff?text=Image+Not+Found';">
                    <div class="p-5">
                        <h3 class="text-lg font-semibold mb-2">${product.name}</h3>
                        <p class="text-gray-600 text-sm mb-3">${product.description}</p>
                        <div class="flex justify-between items-center">
                            <span class="text-xl font-bold" style="color: var(--color-primary);">$${formatPrice(product.price)}</span>
                            <button class="btn btn-primary text-sm add-to-cart-button" data-product-id="${product.id}">Add to Cart</button>
                        </div>
                    </div>
                `;
                productListDiv.appendChild(card);
            });

             // Add event listeners after products are loaded
            document.querySelectorAll('.add-to-cart-button').forEach(button => {
                button.addEventListener('click', handleAddToCart);
            });
        }

        // --- Cart Management ---
        function loadCartFromStorage() {
            const storedCart = localStorage.getItem('powerArkaCart'); // Changed storage key
            if (storedCart) {
                cart = JSON.parse(storedCart);
            } else {
                cart = [];
            }
            updateCartDisplay();
        }

        function saveCartToStorage() {
            localStorage.setItem('powerArkaCart', JSON.stringify(cart)); // Changed storage key
        }

        function handleAddToCart(event) {
            const productId = event.target.dataset.productId;
            const product = products.find(p => p.id === productId);
            if (!product) return;

            const existingItem = cart.find(item => item.id === productId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            saveCartToStorage();
            updateCartDisplay();
            showMessage(`${product.name} added to cart!`, 'success');
        }

         function updateCartItemQuantity(productId, change) {
            const cartItem = cart.find(item => item.id === productId);
            if (cartItem) {
                cartItem.quantity += change;
                if (cartItem.quantity <= 0) {
                    // Remove item if quantity is zero or less
                    cart = cart.filter(item => item.id !== productId);
                }
                saveCartToStorage();
                updateCartDisplay();
            }
        }

        function removeCartItem(productId) {
             cart = cart.filter(item => item.id !== productId);
             saveCartToStorage();
             updateCartDisplay();
             showMessage('Item removed from cart.', 'info');
        }


        function updateCartDisplay() {
            cartItemsDiv.innerHTML = ''; // Clear current items
            let total = 0;
            let itemCount = 0;

            if (cart.length === 0) {
                emptyCartMessage.style.display = 'block';
                cartSummaryDiv.classList.add('hidden');
            } else {
                emptyCartMessage.style.display = 'none';
                cart.forEach(item => {
                    const itemElement = document.createElement('div');
                    itemElement.className = 'flex justify-between items-center bg-white p-4 rounded-lg shadow';
                    // Updated quantity/remove buttons for better click area and styling
                    itemElement.innerHTML = `
                        <div class="flex items-center space-x-4">
                             <img src="${item.imageUrl || 'https://placehold.co/60x60/cccccc/ffffff?text=N/A'}" alt="${item.name}" class="w-16 h-16 object-cover rounded" onerror="this.onerror=null; this.src='https://placehold.co/60x60/cccccc/ffffff?text=N/A';">
                             <div>
                                <h4 class="font-semibold">${item.name}</h4>
                                <p class="text-sm text-gray-600">$${formatPrice(item.price)}</p>
                             </div>
                        </div>
                        <div class="flex items-center space-x-2">
                             <button class="quantity-change h-8 w-8 rounded border text-gray-600 hover:bg-gray-100 flex items-center justify-center" data-id="${item.id}" data-change="-1">-</button>
                             <span class="font-medium w-8 text-center">${item.quantity}</span>
                             <button class="quantity-change h-8 w-8 rounded border text-gray-600 hover:bg-gray-100 flex items-center justify-center" data-id="${item.id}" data-change="1">+</button>
                             <button class="remove-item text-red-500 hover:text-red-700 ml-3 p-1" data-id="${item.id}" title="Remove item"><i class="fas fa-trash fa-sm"></i></button>
                        </div>
                    `;
                    cartItemsDiv.appendChild(itemElement);
                    total += item.price * item.quantity;
                    itemCount += item.quantity;
                });

                // Add event listeners for quantity change and remove buttons
                cartItemsDiv.querySelectorAll('.quantity-change').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.dataset.id;
                        const change = parseInt(button.dataset.change);
                        updateCartItemQuantity(id, change);
                    });
                });
                 cartItemsDiv.querySelectorAll('.remove-item').forEach(button => {
                    button.addEventListener('click', () => {
                        const id = button.dataset.id;
                        removeCartItem(id);
                    });
                });


                cartSummaryDiv.classList.remove('hidden');
                cartTotalSpan.textContent = formatPrice(total);
            }
            cartCountSpan.textContent = itemCount; // Update cart count in header
        }


        // --- Checkout ---
        function loadCheckoutSummary() {
             checkoutSummaryDiv.innerHTML = ''; // Clear previous summary
             let total = 0;
             if (cart.length === 0) {
                 checkoutSummaryDiv.innerHTML = '<p class="text-gray-600">Your cart is empty. Add items to proceed.</p>';
                 checkoutTotalSpan.textContent = formatPrice(0);
                 placeOrderButton.disabled = true;
                 // placeOrderButton.classList.add('opacity-50', 'cursor-not-allowed'); // Opacity handled by CSS :disabled
                 return;
             }

             cart.forEach(item => {
                 const itemElement = document.createElement('div');
                 itemElement.className = 'flex justify-between text-sm';
                 itemElement.innerHTML = `
                     <span>${item.name} (x${item.quantity})</span>
                     <span class="font-medium">$${formatPrice(item.price * item.quantity)}</span>
                 `;
                 checkoutSummaryDiv.appendChild(itemElement);
                 total += item.price * item.quantity;
             });

             checkoutTotalSpan.textContent = formatPrice(total);
             placeOrderButton.disabled = false;
             // placeOrderButton.classList.remove('opacity-50', 'cursor-not-allowed'); // Opacity handled by CSS :disabled
        }

        function handlePlaceOrder(event) {
            event.preventDefault(); // Prevent default form submission if attached to a form

            // Basic form validation (example)
            const requiredFields = document.querySelectorAll('#shipping-form input[required]');
            let isValid = true;
            requiredFields.forEach(field => {
                // Remove previous error state
                field.classList.remove('border-red-500');
                if (!field.value.trim()) {
                    isValid = false;
                    field.classList.add('border-red-500'); // Highlight invalid field
                }
            });

             if (!isValid) {
                 showMessage('Please fill in all required shipping fields.', 'error');
                 return; // Stop if validation fails
             }


            const selectedPaymentMethod = document.querySelector('input[name="payment"]:checked').value;
            const shippingInfo = {
                name: document.getElementById('name').value,
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value,
                zip: document.getElementById('zip').value,
                phone: document.getElementById('checkout-phone').value,
            };

            console.log("Placing Order (Simulated):");
            console.log("Shipping Info:", shippingInfo);
            console.log("Cart Items:", cart);
            console.log("Total:", checkoutTotalSpan.textContent); // Use checkout total
            console.log("Payment Method:", selectedPaymentMethod);

            // **IMPORTANT**: Backend integration needed here.

            // --- Simulation ---
            showMessage(`Order placed successfully (Simulated) using ${selectedPaymentMethod}. Thank you!`, 'success');
            // Clear cart after simulated successful order
            cart = [];
            saveCartToStorage();
            updateCartDisplay();
            navigateTo('home');
            // Reset checkout form
            document.getElementById('shipping-form').reset();
             // Ensure checkout button is disabled again after order
             loadCheckoutSummary();
        }


        // --- Firebase Authentication ---

        // Setup reCAPTCHA verifier
        function setupRecaptcha(containerId) {
            const container = document.getElementById(containerId);
            if (!container) {
                console.error("reCAPTCHA container not found:", containerId);
                return;
            }
            container.innerHTML = ''; // Ensure container is empty

            setTimeout(() => {
                try {
                    // Ensure previous verifier instance is cleared if exists
                    if (window.recaptchaVerifier && typeof window.recaptchaVerifier.clear === 'function') {
                        window.recaptchaVerifier.clear();
                    }

                    window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier(containerId, {
                        'size': 'invisible',
                        'callback': (response) => {
                            console.log("reCAPTCHA solved (invisible)");
                        },
                        'expired-callback': () => {
                            showMessage('reCAPTCHA verification expired. Please try sending OTP again.', 'error');
                            resetRecaptcha(containerId);
                        }
                    });
                    // Render the reCAPTCHA explicitly
                    window.recaptchaVerifier.render().then(function(widgetId) {
                        window.recaptchaWidgetId = widgetId;
                        console.log("reCAPTCHA rendered, widget ID:", widgetId);
                    }).catch(error => {
                         console.error("Error rendering reCAPTCHA:", error);
                         showMessage(`Error setting up reCAPTCHA: ${error.message}. Ensure the container ID '${containerId}' exists and is visible.`, 'error');
                    });
                } catch (error) {
                    console.error("Error initializing reCAPTCHA verifier:", error);
                    showMessage(`Failed to initialize reCAPTCHA: ${error.message}`, 'error');
                }
            }, 150); // Slightly increased delay
        }

        function resetRecaptcha(containerId) {
             console.log("Attempting to reset reCAPTCHA for container:", containerId);
             // Re-initializing is often the most reliable way for invisible reCAPTCHA
             setupRecaptcha(containerId);
        }


        // Handle Email/Password Signup
        function handleSignup(event) {
            event.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;

            auth.createUserWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log('Signup successful:', user);
                    showMessage('Signup successful! Welcome.', 'success');
                })
                .catch((error) => {
                    console.error('Signup error:', error);
                    showMessage(`Signup failed: ${error.message}`, 'error');
                });
        }

        // Handle Email/Password Login
        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            auth.signInWithEmailAndPassword(email, password)
                .then((userCredential) => {
                    const user = userCredential.user;
                    console.log('Login successful:', user);
                     showMessage('Login successful!', 'success');
                })
                .catch((error) => {
                     console.error('Login error:', error);
                     showMessage(`Login failed: ${error.message}`, 'error');
                });
        }

        // Handle Send OTP (Common for Login/Signup)
        function handleSendOtp(phoneInputId, recaptchaContainerId, otpSectionId) {
            const phoneNumber = document.getElementById(phoneInputId).value;
             if (!phoneNumber || !/^\+[1-9]\d{1,14}$/.test(phoneNumber)) {
                showMessage('Please enter a valid phone number with country code (e.g., +16505551234).', 'error');
                return;
            }

            // Ensure reCAPTCHA is ready before proceeding
            if (!window.recaptchaVerifier || typeof window.recaptchaVerifier.render !== 'function') {
                 showMessage('reCAPTCHA is not ready. Please wait a moment and try again.', 'error');
                 // Attempt to re-initialize if it seems missing
                 resetRecaptcha(recaptchaContainerId);
                 return;
            }

             const appVerifier = window.recaptchaVerifier;

             auth.signInWithPhoneNumber(phoneNumber, appVerifier)
                .then((confirmationResult) => {
                    window.confirmationResult = confirmationResult;
                    currentConfirmationResult = confirmationResult;
                    console.log('OTP sent to', phoneNumber);
                    showMessage('OTP sent successfully! Check your phone.', 'success');
                    document.getElementById(otpSectionId).classList.remove('hidden');
                }).catch((error) => {
                    console.error('Error sending OTP:', error);
                    showMessage(`Error sending OTP: ${error.message}. Check console. Ensure number format is correct & reCAPTCHA verified.`, 'error');
                    resetRecaptcha(recaptchaContainerId); // Reset reCAPTCHA on error
                    document.getElementById(otpSectionId).classList.add('hidden');
                });
        }

        // Handle Verify OTP (Common for Login/Signup)
         function handleVerifyOtp(otpInputId, successCallback) {
            const code = document.getElementById(otpInputId).value;
             if (!code || code.length !== 6 || !/^\d{6}$/.test(code)) {
                showMessage('Please enter the 6-digit OTP code.', 'error');
                return;
            }

            const confirmationResultToUse = window.confirmationResult || currentConfirmationResult;

            if (!confirmationResultToUse) {
                showMessage('Verification session expired or invalid. Please request OTP again.', 'error');
                // Hide OTP input sections if session is invalid
                 document.getElementById('otp-login-section')?.classList.add('hidden');
                 document.getElementById('otp-signup-section')?.classList.add('hidden');
                return;
            }

            confirmationResultToUse.confirm(code).then((result) => {
                const user = result.user;
                console.log('Phone authentication successful:', user);
                showMessage('Phone verification successful!', 'success');
                window.confirmationResult = null;
                currentConfirmationResult = null;
                 // Hide OTP input sections after success
                 document.getElementById('otp-login-section')?.classList.add('hidden');
                 document.getElementById('otp-signup-section')?.classList.add('hidden');
                if (successCallback) successCallback(user);
            }).catch((error) => {
                console.error('Error verifying OTP:', error);
                showMessage(`OTP verification failed: ${error.message}`, 'error');
            });
        }


        // Handle Logout
        function handleLogout() {
            auth.signOut().then(() => {
                console.log('User signed out');
                showMessage('You have been logged out.', 'info');
                cart = []; // Clear cart on logout
                saveCartToStorage();
                updateCartDisplay();
                navigateTo('home');
            }).catch((error) => {
                console.error('Sign out error:', error);
                showMessage(`Logout failed: ${error.message}`, 'error');
            });
        }

        // --- Authentication State Observer ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is signed in
                console.log('Auth state changed: User is signed in', user);
                authLinks.classList.add('hidden');
                userLinks.classList.remove('hidden');
                userGreeting.textContent = `Hi, ${user.displayName || user.email || user.phoneNumber || 'User'}`;

                const currentPageId = document.querySelector('.page.active')?.id;
                if (currentPageId === 'login' || currentPageId === 'signup') {
                    navigateTo('home');
                }
                 loadCartFromStorage(); // Load user's cart

            } else {
                // User is signed out
                console.log('Auth state changed: User is signed out');
                authLinks.classList.remove('hidden');
                userLinks.classList.add('hidden');
                userGreeting.textContent = '';
                 // If not logged in, ensure cart reflects local storage (which might be empty or from previous session)
                 loadCartFromStorage();
            }
        });

        // --- Event Listeners ---
        function setupEventListeners() {
            // Navigation
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    // Allow default behavior for external links if any, prevent for hash links
                    if (link.getAttribute('href')?.startsWith('#')) {
                         e.preventDefault();
                         const pageId = link.dataset.page;
                         if (pageId && document.getElementById(pageId)) {
                             navigateTo(pageId);
                             // Setup reCAPTCHA only when navigating TO the auth pages
                             if (pageId === 'login') {
                                 setupRecaptcha('recaptcha-container-login');
                                 document.getElementById('otp-login-section').classList.add('hidden');
                             } else if (pageId === 'signup') {
                                 setupRecaptcha('recaptcha-container-signup');
                                 document.getElementById('otp-signup-section').classList.add('hidden');
                             } else if (pageId === 'cart') {
                                 updateCartDisplay();
                             } else if (pageId === 'checkout') {
                                 loadCheckoutSummary();
                             }
                         } else if (pageId) {
                              console.warn(`Navigation target page with id "${pageId}" not found.`);
                         }
                    }
                });
            });

            // Auth Forms
            document.getElementById('signup-form')?.addEventListener('submit', handleSignup);
            document.getElementById('login-form')?.addEventListener('submit', handleLogin);
            document.getElementById('logout-button')?.addEventListener('click', handleLogout);

            // Phone Auth Buttons
            document.getElementById('send-otp-button')?.addEventListener('click', () => handleSendOtp('login-phone', 'recaptcha-container-login', 'otp-login-section'));
            document.getElementById('verify-otp-login-button')?.addEventListener('click', () => handleVerifyOtp('login-otp'));

            document.getElementById('send-otp-signup-button')?.addEventListener('click', () => handleSendOtp('signup-phone', 'recaptcha-container-signup', 'otp-signup-section'));
             document.getElementById('verify-otp-signup-button')?.addEventListener('click', () => handleVerifyOtp('signup-otp', (user) => {
                 console.log("Phone signup verified for user:", user);
             }));


            // Checkout
            checkoutButton?.addEventListener('click', () => navigateTo('checkout'));
            placeOrderButton?.addEventListener('click', handlePlaceOrder);

             // Set current year in footer
             document.getElementById('current-year').textContent = new Date().getFullYear();
        }

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            loadCartFromStorage(); // Load cart initially
            setupEventListeners();

             // Handle initial page load based on hash, AFTER setting up listeners
            const initialHash = window.location.hash.substring(1);
            const validPageIds = Array.from(pages).map(p => p.id);

            if (initialHash && validPageIds.includes(initialHash)) {
                navigateTo(initialHash);
                 // Setup reCAPTCHA if landing directly on auth pages
                 if (initialHash === 'login') {
                     setupRecaptcha('recaptcha-container-login');
                 } else if (initialHash === 'signup') {
                     setupRecaptcha('recaptcha-container-signup');
                 }
            } else {
                navigateTo('home'); // Default to home page
                 window.location.hash = 'home'; // Set hash to home if invalid/empty
            }
            // Initial auth state check will happen automatically via onAuthStateChanged
        });

    </script>

</body>
</html>
